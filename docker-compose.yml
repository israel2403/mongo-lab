services:
  mongo:
    image: "mongo:${MONGO_VERSION:-7}"
    container_name: mongo7
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_INITDB_ROOT_USERNAME:-root}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_INITDB_ROOT_PASSWORD:-root}"
      TZ: "${TZ:-America/Mexico_City}"
    healthcheck:
      test: ["CMD-SHELL", "mongosh --username $$MONGO_INITDB_ROOT_USERNAME --password $$MONGO_INITDB_ROOT_PASSWORD --eval 'db.adminCommand({ ping: 1 })' --quiet || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 40
    volumes:
      # Persistent database files (named volume recommended)
      - mongo-data:/data/db
      # Optional: bind-mount instead (uncomment the next line and comment the named volume)
      # - ./data:/data/db
      # Config (read-only)
      - ./docker/mongo/conf/mongod.conf:/etc/mongod.conf:ro
    command: ["mongod", "--config", "/etc/mongod.conf"]

  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_MONGODB_ADMINUSERNAME: "${MONGO_INITDB_ROOT_USERNAME:-root}"
      ME_CONFIG_MONGODB_ADMINPASSWORD: "${MONGO_INITDB_ROOT_PASSWORD:-root}"
      ME_CONFIG_BASICAUTH_USERNAME: "${ME_BASIC_USER:-admin}"
      ME_CONFIG_BASICAUTH_PASSWORD: "${ME_BASIC_PASS:-admin}"
      TZ: "${TZ:-America/Mexico_City}"
    # (mongo-express is stateless; no volume required)

volumes:
  mongo-data:
